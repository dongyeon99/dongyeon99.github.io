---
layout: post
title: Linux job scheduler "Slurm" 사용 및 관리
subtitle: 클러스터 Slurm 관리, 사용 하기
categories: [Linux]
tags: [Linux, Slurm, job scheduler]
comments: true
---

## 목차
#### 1. Job Script 만들기
#### 2. Job 제출, 확인, 삭제
#### 3. 환경 설정
#### 4. 자주 발생하는 문제 및 해결 방법

<br/>

#### Slurm은 linux cluster 환경에서 사용되는 Schedular 중 하나입니다. slurm이 GPU schedule 관리 기능을 지원하기도 합니다.

<br/>

### - 기본명령어 요약
| Command                     |                       Explanation                         |
| --------------------------- | :-------------------------------------------------------: |
| $ sbatch [옵션..] 스크립트   | 작업 제출                                                  |
| $ scancel 작업ID            | 작업 삭제                                                   |
| $ squeue                    | 작업 상태 확인                                              |
| $ smap                      | 작업 상태 및 노드 상태 확인                                  |
| $ sinfo [옵션..]            | 노드 정보 확인                                              |

<br/>

### - $ sbatch
작업 제출을 위한 command입니다. 사용방법 및 예시는 아래와 같습니다.

```linux
$ sbatch ./job_script.bash
```

### - Job Script (slurm) command 
```linux
#!/bin/sh

#SBATCH -J test            # 작업 이름
#SBATCH -p cas_v100_2      # partition 이름 작업 수행할 파티션을 지정하는 것이며, 사용가능한 파티션 이름은 sinfo 명령어로 확인이 가능
#SBATCH -N 2               # 총 필요한 컴퓨팅 노드 수, 작업 수행에 필요한 총 프로세스 수는 "-n" 옵션으로 정의
#SBATCH -n 2               # 총 필요한 프로세스 수, 작업 수행에 필요한 컴퓨팅 노드 개수는 "-N"으로 정의
#SBATCH -o %x.o%j          # stdout 파일 명(.o) Standard output을 저장할 파일명을 정의
#SBATCH -e %x.e%j          # stderr 파일 명(.e) Standard error 를 저장할 파일명을 정의
#SBATCH --comment          # Application별 SBATCH 옵션 (옵션명은 아래 작업스크립트 작성 안내 참고)
#SBATCH --time 00:30:00    # 최대 작업 시간 (Wall Time Clock Limit), 예상되는 작업 소요 시간을 의미, 실제 예상되는 작업 소요 시간보다 약간 더 길게 설정해 주는 것이 안전합니다. 만약 해당 작업이 설정해 둔 시간내에 종료 되지 않을 경우, Wall Time Clock Limit 시간을 초과하는 시점에서 slurm이 해당 작업을 강제로 종료시킵니다. 이 키워드는 작업 제출 스크립트 파일에 반드시 지정되어야 하며, 초단위 또는 시:분:초 형식으로 지정할 수 있습니다. Wall Time Clock Limit을 1시간을 지정할 경우, "--time=01:00:00: 또는 "-t 01:00:00" 과 같이 사용합니다.
#SBATCH --gres=gpu:2       # GPU를 사용하기 위한 옵션

srun ./run.x               # srun 사용
```

<br/>



<br/>

## 1. Job Script 만들기
slurm을 사용하기 전 수행할 job을 기록하는 job script를 만들어야 합니다. 이때 linux의 기본 Shell인 bash를 이용해 보았습니다.
bioinfomatics와 관련된 예시를 통해 파일을 만들어봅니다. samtools라는 tool을 이용해서 bam 파일을 sam 파일로 변환하는 작업을 해보겠습니다.

```linux
samtools view allignments.bam > alignments.sam
```
이를 bash script를 통해 만들어 준다면 다음과 같습니다.

```linux
#!/bin/bash
samtools view alignments.bam > alignments.sam
```

앞의 Script를 사용하여 작업을 제출해도 되지만, slurm Schedular에 넘겨줄 여러 옵션들을 script 파일 내용에 추가로 적어줄 수 있습니다. 
"#SBATCH" 이 그러한 기능을 하는 부분입니다. 이 부분은 # 으로 시작했기 때문에 bash 입장에서는 주석으로 여겨지므로 아무런 영향이 없고, slurm 에서는 #SBATCH 를 인식하여 이 부분은 수행할 작업에 대한 옵션으로 해석됩니다.

```linux
#!/bin/bash

#SBATCH -J Sukjun.samtools          # job name
#SBATCH -o Sukjun.samtools.%j.out   # standard output and error log

samtools view alignments.bam > alignments.sam
```

